<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TechZCLoud</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../static/css/home.css">

</head>

<body>

    <!-- Navbar -->

    <nav class="navbar navbar-expand-lg " data-bs-theme=dark>
        <div class="container container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <img src=/static/logo.png alt=Bootstrap width=40 height=40 class="d-inline-block align-text-top"><span
                    style="margin-left: 10px;" class="navbar-brand mb-0 h1">TechZ Index</span></a>
        </div>
    </nav>


    <!-- Upload div -->

    <div id="udiv-main" class="card m-5 text-center p-2">
        <h4>Upload your file</h4>
        <div id="udiv-inner" class="card p-2 ">
            <div id="form-div">
                <form id="upload-form" class="p-1">
                    <input class="form-control " type="file" id="file-input">
                    <button type="submit" class="btn btn-primary mt-2 col-4" value="Upload">Upload</button>
                    <div style="display: none;" class="progress-bar">
                        <div id="progress"></div>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Progress div -->

    <div id="udiv2-main" class="card m-5 text-center p-2" style="display: none;">
        <h4>Uploading...</h4>
        <div id="udiv-inner" class="card p-2 ">
            <table class="table">
                <tbody>
                    <tr>
                        <th scope="row">File Name</th>
                        <td id="vfile">File Name</td>
                    </tr>
                    <tr>
                        <th scope="row">Remaining Time</th>
                        <td id="vtime">Remaining Time</td>
                    </tr>
                    <tr>
                        <th scope="row">Progress</th>
                        <td id="vprog">Progress</td>
                    </tr>
                    <tr>
                        <th scope="row">Average Speed</th>
                        <td id="vspeed">Average Speed</td>
                    </tr>
                </tbody>
            </table>

            <div class="progress-bar">
                <div id="progressor"></div>
            </div>
        </div>
    </div>


    <script>
        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes'

            const k = 1024
            const dm = decimals < 0 ? 0 : decimals
            const sizes = ['Bytes', 'KB', 'MB', 'GB']

            const i = Math.floor(Math.log(bytes) / Math.log(k))

            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`
        }

        function formatTime(sec_num) {
            const hours = Math.floor(sec_num / 3600);
            const minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            const seconds = Math.floor(sec_num - (hours * 3600) - (minutes * 60));

            let text = ''
            if (hours > 0) {
                text += hours + 'hour '
                if (minutes > 0) {
                    text += minutes + 'min '
                }
            }
            else if (minutes > 0) {
                text += minutes + 'min '
                if (seconds > 0) {
                    text += seconds + 'sec'
                }
            }
            else {
                text += seconds + 'sec'
            }
            return text
        }


        const form = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const progressBar = document.getElementById('progressor');
        const vfile = document.getElementById('vfile');
        const vtime = document.getElementById('vtime');
        const vprog = document.getElementById('vprog');
        const vspeed = document.getElementById('vspeed');
        const udiv1 = document.getElementById('udiv-main');
        const udiv2 = document.getElementById('udiv2-main');

        form.addEventListener('submit', e => {
            try {
                e.preventDefault();

                const file = fileInput.files[0];
                const formData = new FormData();
                if (file) {
                    udiv1.style.display = "none";
                    udiv2.style.display = "flex";
                    vfile.innerHTML = file.name;
                    vtime.innerHTML = "Calculating...";
                    vprog.innerHTML = "0%";
                    vspeed.innerHTML = "Calculating...";
                    let done = 0;
                    let time = new Date().getTime();

                    formData.append('file', file);
                    formData.append('Connection', 'keep-alive');
                    const xhr = new XMLHttpRequest();
                    xhr.open('POST', '/upload', true);
                    xhr.upload.onprogress = e => {
                        if (e.lengthComputable) {
                            ctime = new Date().getTime()
                            if (((ctime) - (time)) > 1000) {
                                time = ctime;
                                speed = e.loaded - done
                                tRemaining = formatTime((e.total - e.loaded) / speed)
                                speed = formatBytes(speed).toString() + "/s";

                                const percentComplete = Math.round((e.loaded / e.total) * 100);
                                progressBar.style.width = `${percentComplete}%`;
                                vprog.innerHTML = formatBytes(e.loaded) + "/" + formatBytes(e.total) + " | " + percentComplete + "%";
                                vtime.innerHTML = tRemaining;
                                vspeed.innerHTML = speed;

                                done = e.loaded
                            }
                            console.log(e.loaded / e.total)
                        }

                    };
                    xhr.send(formData);

                    xhr.onerror = e => {
                        udiv1.style.display = "flex";
                        udiv2.style.display = "none";
                        alert('Error! Upload failed. Can\'t connect to server.');
                    };
                }
                else {
                    alert('Select a file first');
                }
            }
            catch (err) {
                udiv1.style.display = "flex";
                udiv2.style.display = "none";
                alert(err)
            }

        });
    </script>
</body>

</html>